package main

import (
	"context"
	"fmt"
	"log"
	"math/rand"
	"os"
	"time"

	"github.com/joho/godotenv"

	"github.com/go-telegram/bot"
	"github.com/go-telegram/bot/models"
)

func main() {
	err := godotenv.Load()
	if err != nil {
		log.Fatal("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ .env —Ñ–∞–π–ª–∞")
	}

	telegram_token := os.Getenv("TELEGRAM_TOKEN")
	// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ —Å —Ç–æ–∫–µ–Ω–æ–º
	b, err := bot.New(telegram_token)
	if err != nil {
		log.Fatal(err)
	}

	// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ –∫–æ–º–∞–Ω–¥
	commands := []models.BotCommand{
		{Command: "murmansk", Description: "–£–∑–Ω–∞—Ç—å, —Å–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–ª–æ—Å—å –¥–æ –ø–æ–µ–∑–¥–∫–∏ –≤ –ú—É—Ä–º–∞–Ω—Å–∫"},
		// –î–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–≥–∏–µ –∫–æ–º–∞–Ω–¥—ã, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
	}
	_, err = b.SetMyCommands(context.Background(), &bot.SetMyCommandsParams{
		Commands: commands,
	})
	if err != nil {
		log.Fatalf("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∫–æ–º–∞–Ω–¥: %v", err)
	}

	// –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /mur–º–∞–Ω—Å–∫
	b.RegisterHandler(bot.HandlerTypeMessageText, "/murmansk", bot.MatchTypeExact, murmanskHandler)

	// –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
	b.Start(context.Background())
}

func murmanskHandler(ctx context.Context, b *bot.Bot, update *models.Update) {
	// –ó–∞–¥–∞—ë–º —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –¥–ª—è –ú–æ—Å–∫–≤—ã (UTC+3)
	moscowLocation := time.FixedZone("MSK", 3*60*60)

	funnyPhrases := []string{
		"–î–∞–º—ã –∏ –≥–æ—Å–ø–æ–¥–∞, –Ω–∞ –≤–∞—à–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö ‚Äî –∫–æ—Å–º–∏—á–µ—Å–∫–∏–π —Ä–µ–π—Å, –∏ –≤—Ä–µ–º—è –¥–æ —Å—Ç–∞—Ä—Ç–∞ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç... üöÄ‚è≥",
		"–ó–∞–±—É–¥—å—Ç–µ –≤—Å–µ, —á—Ç–æ –≤—ã –∑–Ω–∞–ª–∏ –æ –≤—Ä–µ–º–µ–Ω–∏, –≤–æ—Ç –æ–Ω–æ ‚Äî –≤–∞—à–µ –±—É–¥—É—â–µ–µ! üîÆ‚ú®",
		"–ê —Ç–µ–º –≤—Ä–µ–º–µ–Ω–µ–º –Ω–∞ —Å–µ–∫—É–Ω–¥–æ–º–µ—Ä–µ‚Ä¶ –¥–æ —Ç–æ—á–∫–∏ —Å—Ç–∞—Ä—Ç–∞ –æ—Å—Ç–∞–ª–æ—Å—å –≤—Å–µ–≥–æ... ‚è±Ô∏èüî•",
		"–î–∞–º—ã –∏ –≥–æ—Å–ø–æ–¥–∞, –µ—Å–ª–∏ –≤—ã —Ö–æ—Ç–µ–ª–∏ —É–∑–Ω–∞—Ç—å, —Å–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–ª–æ—Å—å –¥–æ —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞ ‚Äî –¥–µ—Ä–∂–∏—Ç–µ—Å—å –∫—Ä–µ–ø—á–µ! –û—Å—Ç–∞–ª–æ—Å—å ‚è≥üí•",
		"–ü—Ä–∏—Å–∞–∂–∏–≤–∞–π—Ç–µ—Å—å –ø–æ—É–¥–æ–±–Ω–µ–µ, –≤—Ä–µ–º—è –¥–æ –ø–æ–µ–∑–¥–∫–∏... üõãÔ∏èüïí",
		"–ü–æ–∫–∞ –º—ã —Ç—É—Ç –±–æ–ª—Ç–∞–µ–º, –¥–æ –≤–∞–∂–Ω–æ–π –¥–∞—Ç—ã –æ—Å—Ç–∞–ª–æ—Å—å –≤—Å–µ–≥–æ... üóìÔ∏è‚è≥",
		"–°–µ–∫—É–Ω–¥—ã —Ç–∞—é—Ç, –∫–∞–∫ —Å–Ω–µ–≥ –Ω–∞ —Å–æ–ª–Ω—Ü–µ, –¥–æ —Å–æ–±—ã—Ç–∏—è –æ—Å—Ç–∞–ª–∞—Å—å —Å–æ–≤—Å–µ–º –º–∞–ª–æ—Å—Ç—å... ‚ùÑÔ∏è‚òÄÔ∏è",
		"–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ –≤—ã –≤ –≥–æ–Ω–∫–µ, –∏ –¥–æ —Å—Ç–∞—Ä—Ç–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –≤—Å–µ–≥–æ... üèÅ‚è∞",
	}

	// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª –æ–¥–∏–Ω —Ä–∞–∑
	rand.Seed(time.Now().Unix())

	// –¶–µ–ª–µ–≤–∞—è –¥–∞—Ç–∞ —Å —É—á—ë—Ç–æ–º –º–æ—Å–∫–æ–≤—Å–∫–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
	targetDate := time.Date(2025, time.April, 26, 0, 0, 0, 0, moscowLocation)

	// –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
	now := time.Now().In(moscowLocation)

	// –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–æ —Ü–µ–ª–µ–≤–æ–π –¥–∞—Ç—ã
	duration := targetDate.Sub(now)

	// –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π, —á–∞—Å–æ–≤ –∏ –º–∏–Ω—É—Ç
	days := int(duration.Hours()) / 24
	hours := int(duration.Hours()) % 24
	minutes := int(duration.Minutes()) % 60

	// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è —Ñ—Ä–∞–∑—ã
	randomPhrase := funnyPhrases[rand.Intn(len(funnyPhrases))]

	// –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∂–∏—Ä–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º
	message := fmt.Sprintf("%s\n**%d –¥–Ω–µ–π, %d —á–∞—Å–æ–≤, %d –º–∏–Ω—É—Ç.**", randomPhrase, days, hours, minutes)

	// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
	b.SendMessage(ctx, &bot.SendMessageParams{
		ChatID:    update.Message.Chat.ID,
		Text:      message,
		ParseMode: "Markdown",
	})
}
